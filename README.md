# 暗仓 (Dark Pool) - 金融模拟交易游戏

## 项目简介

《暗仓》是一款多人在线金融模拟交易游戏，玩家扮演不同的市场角色（散户或操盘手），通过买卖股票、分析舆情等方式进行虚拟交易，体验金融市场中的信息不对称和博弈策略。

## 功能特点

- 多人在线实时交易
- 两种角色设定：散户和操盘手
- 实时股价波动模拟
- 舆情影响系统
- 做空机制与融资融券
- 留言板交流系统
- 排行榜竞争机制
- AI驱动的实时新闻生成
- URL Token自动登录系统

## 技术架构

### 核心组件

- **后端**: Python + Streamlit/Gradio 提供交互
- **前端**: Streamlit 页面（默认），保留 Gradio 入口作为备选
- **图表**: Plotly交互式K线图
- **AI**: 支持大型语言模型生成实时财经新闻
- **数据存储**: 内存存储（单轮游戏生命周期）

### 项目结构

```
darkpool/
├── streamlit_app.py    # 新版 Streamlit 前端（玩家端 + 管理端）
├── app.py              # 旧版 Gradio 入口（保留）
├── backend.py          # 后端逻辑封装和数据接口
├── shared.py           # 全局共享的游戏状态实例
├── requirements.txt    # Python依赖包列表
├── environment.yml     # Conda环境配置
├── README.md           # 项目说明文档
├── assets/             # 静态资源目录
│   └── login.png       # 登录页面图片 （自行添加）
├── scripts/            # 功能模块目录
│   ├── game_state.py   # 核心游戏逻辑和状态管理
│   ├── player_manager.py # 玩家数据结构定义
│   ├── ui_manager.py   # 界面管理（已弃用，逻辑整合到backend.py中）
│   ├── admin_functions.py # 管理员功能
│   └── news_system.py  # 新闻系统
└── savedata/           # 游戏报告保存目录
```

## 快速开始

### 环境准备

#### 方法一：使用Conda（推荐）

```bash
# 创建并激活环境
conda env create -f environment.yml
conda activate darkpool

# 运行新版 Streamlit 前端（推荐）
streamlit run streamlit_app.py --server.port 8001 --server.headless true
```

#### 方法二：使用pip

```bash
# 安装依赖
pip install -r requirements.txt

# 运行新版 Streamlit 前端（推荐）
streamlit run streamlit_app.py --server.port 8001 --server.headless true
```

### 配置新闻系统API（可选）

新闻系统支持通过大型语言模型生成实时财经新闻。要启用此功能，请执行以下步骤：

1. 在项目根目录创建 `.env` 文件
2. 添加您的API密钥：
   ```
   DEEPSEEK_API_KEY=your_actual_api_key_here
   ```

如果没有API密钥，系统将自动使用内置的新闻模板。

### 启动应用

```bash
streamlit run streamlit_app.py --server.port 8001 --server.headless true
```

启动后通过浏览器访问 http://localhost:8001 ，玩家端与管理员端在同一页面的两个 Tab 内切换。
如需使用旧版 Gradio 双端，可运行 `python app.py`（玩家端 8001，管理端 8002）。

## 游戏规则

### 角色设定

1. **散户**: 普通投资者，信息获取能力较弱
2. **操盘手**: 专业投资者，拥有更多信息优势（上帝视角）

### 交易机制

- 初始资金：每位玩家1,000,000元
- 交易费率：每次交易收取5%手续费
- 做空机制：最多可做空当前资金可购买股票数量的2倍
- 融资融券：可以申请贷款，但需支付30%利息
- 结算机制：游戏结束后按最终资产排名，并收取10%管理费
- 强制平仓：当保证金比例低于110%时会被强制平仓
- 交易冷却：每次交易后需要等待3小时才能进行下一次交易

### 舆情系统

- 玩家可花费5,000元购买舆情信息影响市场走势
- 操盘手的影响力度是散户的5倍
- 舆情影响有边界限制，不会无限增强

### 游戏流程

1. **报名阶段**: 玩家注册并等待游戏开始
2. **交易阶段**: 12小时的交易时间，每小时股价会根据市场因素变化
3. **结算阶段**: 游戏结束，根据资产排名确定胜负

## 管理员功能

管理员可以通过管理界面执行以下操作：
- 强制开始游戏
- 跳过1小时
- 快进至游戏结束
- 重新开始游戏

## 登录系统

本系统支持两种登录方式：

### 手动登录
玩家输入邮箱和操盘代号进行登录。

### URL Token自动登录
1. 玩家首次登录后，系统会生成一个专属免密登录链接
2. 玩家可以将该链接保存为书签或收藏
3. 下次访问时直接使用该链接即可自动登录

## 开发说明

### 代码规范

- 遵循PEP8代码风格
- 模块化设计，职责分离
- 关键算法有详细注释

### 主要模块说明

1. `streamlit_app.py`: 默认 Streamlit 前端，包含玩家端和管理员端两个 Tab
2. `app.py`: 旧版 Gradio 界面（保留便于回退）
3. `backend.py`: 后端逻辑封装和数据接口，包括图表绘制功能
4. `scripts/game_state.py`: 核心游戏逻辑和状态管理，包含玩家和游戏状态类
5. `scripts/news_system.py`: 新闻生成和管理系统，支持AI生成新闻
6. `scripts/player_manager.py`: 玩家数据结构定义

## 常见问题

### 无法开始游戏？

确保有玩家注册后再点击"强制开始游戏"按钮。

### 调试功能无效？

检查是否在正确的游戏阶段使用调试功能，部分功能仅在特定阶段可用。

### 新闻系统API连接超时？

这是正常现象，系统设置了超时时间以避免影响游戏体验。超时后会自动使用备用的新闻模板。

## 版权信息

本项目仅供学习交流使用，不构成任何投资建议。